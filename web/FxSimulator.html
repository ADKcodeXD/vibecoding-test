<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FX Pro Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');

        :root {
            --bg-dark: #0b1221;
            --bg-panel: #161e2e;
            --bull-green: #22c55e;
            --bear-red: #ef4444;
            --text-primary: #f3f4f6;
            --line-cost: #3b82f6; 
            --line-liq: #f97316;  
        }

        body {
            font-family: 'Noto Sans SC', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* 输入框样式 */
        .stealth-input {
            background: #1f2937;
            border: 1px solid #374151;
            color: white;
            padding: 0.15rem 0.25rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.875rem;
            width: 100%;
        }
        .stealth-input:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .price-input {
            background: transparent;
            border: none;
            color: inherit;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        .price-input:focus { outline: none; background: rgba(255,255,255,0.05); border-radius: 4px; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* 价格滑条样式 */
        .price-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            background: linear-gradient(to right, #ef4444 0%, #374151 50%, #22c55e 100%);
            border-radius: 6px;
            outline: none;
            cursor: pointer;
            touch-action: manipulation;
        }
        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #374151;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            margin-top: -8px;
            transition: transform 0.1s;
        }
        .price-slider:active::-webkit-slider-thumb {
            transform: scale(1.2);
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .price-slider::-webkit-slider-runnable-track {
            height: 12px;
            border-radius: 6px;
        }

        /* 普通/杠杆滑条 */
        .mini-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            margin-top: 4px;
        }
        .mini-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #94a3b8;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .mini-slider:hover::-webkit-slider-thumb {
            background: #cbd5e1;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background-color: var(--bull-green);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--bull-green);
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        select.dark-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 1.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        .order-book-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 1px 4px;
            font-family: 'JetBrains Mono', monospace;
        }
        .order-book-bar {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            opacity: 0.15;
            z-index: 0;
        }
        
        @media (max-width: 640px) {
            .price-input { width: 110px; font-size: 1.25rem; }
            .control-label { font-size: 0.65rem; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- 顶部 Header -->
    <header class="flex-none flex items-center justify-between px-3 py-2 sm:px-4 sm:py-3 bg-slate-900 border-b border-slate-800 z-20">
        <div class="flex items-center gap-2 sm:gap-3">
            <button id="btn-settings" class="text-slate-400 hover:text-white p-1.5 rounded-md hover:bg-slate-800 transition" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>

            <button id="btn-reset" class="text-slate-400 hover:text-white border border-slate-600 hover:border-slate-400 rounded px-2 py-1 text-xs transition flex items-center gap-1" title="Reset">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span data-i18n="reset" class="hidden sm:inline">RESET</span>
            </button>

            <div class="h-5 w-px bg-slate-700 mx-0.5 sm:mx-1"></div>

            <div class="bg-slate-800/80 px-2 py-1 sm:px-3 sm:py-1.5 rounded-lg border border-slate-700 flex items-center gap-2 sm:gap-3">
                <div class="flex flex-col">
                    <select id="symbol-select" class="dark-select bg-transparent text-slate-300 text-xs font-bold outline-none border-none p-0 pr-3 cursor-pointer">
                        <option value="AUDJPY">AUD/JPY</option>
                        <option value="USDJPY">USD/JPY</option>
                    </select>
                    <div class="flex items-center gap-1 text-[9px] text-slate-400 mt-0.5">
                        <span class="opacity-70 hidden sm:inline" data-i18n="leverage_label">Lev:</span>
                        <span class="text-slate-200 font-bold" id="top-leverage-display">1:20</span>
                    </div>
                </div>
                <input type="number" id="current-price-input" class="price-input text-red-400 text-right" value="97.450" step="0.001">
            </div>
            
            <div id="market-status" class="hidden md:flex text-[10px] px-2 py-1 rounded bg-slate-800 text-slate-500 font-mono uppercase tracking-wide cursor-help" data-i18n="trend_range">
                RANGE
            </div>
        </div>

        <div class="text-right flex flex-col items-end justify-center">
            <div class="text-[9px] sm:text-[10px] text-slate-400 uppercase tracking-wider mb-0.5" data-i18n="equity_label">有効証拠金 (Equity)</div>
            <div id="top-equity-display" class="mono text-base sm:text-xl font-bold text-white">¥10,000</div>
        </div>
    </header>

    <!-- 中间内容区 -->
    <div class="flex flex-1 overflow-hidden bg-[#0b1221]">
        
        <!-- 图表区域 -->
        <div class="relative flex-1 bg-[#0b1221] overflow-hidden cursor-ew-resize" id="chart-container">
            <canvas id="klineChart" class="block w-full h-full"></canvas>
            
            <div class="absolute top-2 right-2 sm:top-3 sm:right-4 flex flex-col items-end gap-1 sm:gap-2 z-10" style="right: 60px;">
                <div class="pointer-events-auto">
                    <select id="speed-select" class="dark-select bg-slate-800/90 text-[9px] sm:text-[10px] text-slate-300 border border-slate-700 rounded-md px-2 py-0.5 sm:px-3 sm:py-1 outline-none cursor-pointer hover:border-slate-500 transition shadow-lg font-mono">
                        <option value="500">0.5s</option>
                        <option value="1000">1.0s</option>
                        <option value="3000" selected>3.0s (Def)</option>
                        <option value="5000">5.0s</option>
                        <option value="10000">10s</option>
                        <option value="30000">30s</option>
                        <option value="60000">1 Min</option>
                        <option value="180000">3 Min</option>
                        <option value="300000">5 Min</option>
                    </select>
                </div>
                <div class="pointer-events-none select-none text-[9px] sm:text-[10px] text-slate-600 font-mono bg-slate-900/50 px-2 py-0.5 rounded text-right w-full">
                    <span data-i18n="next_label">Next</span>: <span id="timer-display" class="text-slate-400">--</span>s
                </div>
            </div>

            <div class="absolute top-3 left-4 pointer-events-none select-none opacity-40 text-[10px] text-slate-500 hidden sm:block" data-i18n="hint_label">
                Hint: Scroll to zoom • Drag price slider below
            </div>
        </div>

        <!-- 订单薄侧边栏 -->
        <div class="w-40 bg-[#111827] border-l border-slate-800 flex flex-col z-20 hidden sm:flex">
            <div class="p-2 text-[10px] text-slate-500 font-bold border-b border-slate-800 flex justify-between">
                <span data-i18n="ob_title">ORDER BOOK</span>
                <span class="text-slate-600" data-i18n="ob_vol">Vol</span>
            </div>
            <div id="ob-asks" class="flex-1 flex flex-col justify-end overflow-hidden pb-1"></div>
            <div id="ob-current" class="py-1 bg-slate-800 text-center mono text-sm font-bold text-white border-y border-slate-700">--</div>
            <div id="ob-bids" class="flex-1 flex flex-col justify-start overflow-hidden pt-1"></div>
        </div>

    </div>

    <!-- 底部控制区 -->
    <div class="flex-none bg-slate-900 border-t border-slate-800 p-3 z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.3)]">
        
        <!-- 价格滑块 -->
        <div class="mb-3 flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
            <span class="text-xs text-slate-400 font-bold whitespace-nowrap control-label" id="control-label-text">Control (±2.5%)</span>
            <input type="range" id="price-slider" class="price-slider flex-1" min="-2.5" max="2.5" step="0.01" value="0">
            <button id="reset-view-btn" class="text-[10px] bg-slate-700 hover:bg-slate-600 px-2 py-1 sm:px-3 sm:py-1 rounded text-slate-300 transition whitespace-nowrap" data-i18n="reset_view">Reset View</button>
        </div>

        <!-- 交易设置 -->
        <div class="grid grid-cols-12 gap-2 mb-2 sm:flex sm:gap-2">
            <div class="col-span-3 sm:w-24 flex flex-col gap-1">
                <div class="flex justify-between items-baseline">
                    <label class="text-[9px] sm:text-[10px] text-slate-500" data-i18n="leverage_label">Lev</label>
                    <span id="leverage-display-bottom" class="text-[9px] text-blue-400 font-mono">1:20</span>
                </div>
                <input type="range" id="input-leverage-slider" min="0" max="8" step="1" value="2" class="mini-slider mt-1" title="Leverage">
            </div>
            
            <div class="col-span-5 sm:w-28 flex flex-col gap-1">
                <div class="flex justify-between items-baseline">
                    <label class="text-[9px] sm:text-[10px] text-slate-500" data-i18n="lot_label">Lot</label>
                    <span id="lot-percent-display" class="text-[9px] text-blue-400 font-mono">0%</span>
                </div>
                <input type="number" id="input-lots" class="stealth-input mono font-bold" value="1.0" step="0.1">
                <input type="range" id="lot-percent-slider" min="0" max="100" step="1" value="0" class="mini-slider mt-1">
            </div>

            <div class="col-span-4 sm:w-24 flex flex-col gap-1">
                <label class="text-[9px] sm:text-[10px] text-slate-500 truncate" data-i18n="avg_price_label">Avg Price</label>
                <input type="number" id="input-cost" class="stealth-input mono font-bold text-slate-400 h-[26px]" value="0.000" step="0.001" disabled>
            </div>

            <div class="col-span-12 sm:flex-1 flex flex-col items-center sm:items-end justify-center sm:pr-1 bg-slate-800/30 sm:bg-transparent rounded py-1 sm:py-0">
                <label class="text-[9px] sm:text-[10px] text-slate-500 sm:block hidden" data-i18n="pl_label">P/L</label>
                <div id="bottom-pl-display" class="mono text-lg font-bold text-slate-500">¥0 (0.00%)</div>
            </div>
        </div>

        <!-- 持仓信息 -->
        <div id="pos-info-bar" class="mb-2 p-2 rounded bg-slate-800 border border-slate-700 flex items-center justify-between min-h-[40px] hidden">
            <div class="flex items-center gap-2 sm:gap-3">
                <span id="pos-type-badge" class="px-2 py-0.5 rounded text-xs font-bold uppercase"></span>
                <span id="pos-size-display" class="text-base sm:text-lg font-bold text-white font-mono"></span>
            </div>
            <div class="text-[10px] sm:text-xs text-slate-400 font-mono flex items-center gap-2">
                 <span><span data-i18n="entry_short">Avg</span>: <span id="pos-entry-price" class="text-slate-300"></span></span>
                 <span class="hidden sm:inline">|</span>
                 <span><span data-i18n="current_short">Cur</span>: <span id="pos-current-price" class="text-slate-300"></span></span>
            </div>
        </div>

        <!-- 按钮组 -->
        <div class="grid grid-cols-2 gap-3 h-12">
            <button id="btn-sell" class="bg-gradient-to-br from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white rounded-md shadow-lg flex flex-col items-center justify-center leading-none transition active:scale-[0.98] active:shadow-none">
                <span class="font-bold text-lg" data-i18n="btn_sell">SELL</span>
                <span class="mono text-[10px] opacity-80" id="btn-price-sell">--</span>
            </button>
            <button id="btn-buy" class="bg-gradient-to-br from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white rounded-md shadow-lg flex flex-col items-center justify-center leading-none transition active:scale-[0.98] active:shadow-none">
                <span class="font-bold text-lg" data-i18n="btn_buy">BUY</span>
                <span class="mono text-[10px] opacity-80" id="btn-price-buy">--</span>
            </button>
        </div>

        <div class="flex justify-between mt-2 text-[9px] sm:text-[10px] text-slate-500 px-1">
            <div class="flex items-center gap-1.5">
                <div class="live-dot"></div>
                <span data-i18n="market_open">MARKET OPEN</span>
            </div>
        </div>
    </div>

    <!-- 设置/作弊弹窗 -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm animate-fade-in p-4">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-lg w-full max-w-xs shadow-2xl relative">
            <h2 class="text-white font-bold mb-4 text-lg flex items-center gap-2" data-i18n="settings_title">
                Settings
            </h2>
            
            <div class="mb-4">
                <label class="block text-slate-400 text-xs mb-1" data-i18n="language_label">Language (言語)</label>
                <select id="setting-language" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none">
                    <option value="zh">中文 (Chinese)</option>
                    <option value="en">English</option>
                    <option value="ja">日本語 (Japanese)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-slate-400 text-xs mb-1" data-i18n="initial_balance">Initial Balance</label>
                <input type="number" id="setting-balance" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white font-mono focus:border-blue-500 outline-none" value="10000">
            </div>
            
            <div class="mb-4">
                <label class="block text-slate-400 text-xs mb-1" data-i18n="volatility_label">Volatility</label>
                <select id="setting-volatility" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none">
                    <option value="0.1" data-i18n="vol_low">Low (0.1)</option>
                    <option value="0.2" selected data-i18n="vol_normal">Normal (0.2)</option>
                    <option value="0.8" data-i18n="vol_high">High (0.8)</option>
                    <option value="2.0" data-i18n="vol_extreme">Extreme (2.0)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-slate-400 text-xs mb-1" data-i18n="control_range">Control Range</label>
                <select id="setting-range" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none">
                    <option value="1">±1%</option>
                    <option value="2.5" selected>±2.5% (Default)</option>
                    <option value="5">±5%</option>
                    <option value="10">±10%</option>
                    <option value="30">±30%</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-slate-400 text-xs mb-1" data-i18n="market_regime">Market Regime</label>
                <select id="setting-regime" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none">
                    <option value="auto" data-i18n="regime_auto">AUTO</option>
                    <option value="bull" data-i18n="regime_bull">BULL</option>
                    <option value="range" data-i18n="regime_range">RANGE</option>
                    <option value="bear" data-i18n="regime_bear">BEAR</option>
                </select>
            </div>
            
            <div class="flex gap-2 justify-end">
                <button id="btn-close-settings" class="px-3 py-1 text-slate-400 hover:text-white text-sm transition" data-i18n="btn_cancel">Cancel</button>
                <button id="btn-apply-settings" class="px-4 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold transition shadow-lg" data-i18n="btn_apply">Apply & Reset</button>
            </div>
        </div>
    </div>

    <script>
        const TRANSLATIONS = {
            ja: {
                reset: "リセット",
                leverage_label: "レバレッジ",
                equity_label: "有効証拠金 (Equity)",
                next_label: "次足",
                hint_label: "ヒント: スクロールで拡大/縮小 • スライダーで価格操作",
                ob_title: "板情報 (BOOK)",
                ob_vol: "Vol",
                control_label: "操作",
                reset_view: "最新へ戻る",
                lot_label: "ロット",
                avg_price_label: "平均建値",
                pl_label: "含み損益 (P/L)",
                btn_sell: "売 (SELL)",
                btn_buy: "買 (BUY)",
                market_open: "MARKET OPEN",
                entry_short: "建値",
                current_short: "現在",
                settings_title: "設定 (Settings)",
                language_label: "言語 (Language)",
                initial_balance: "初期証拠金",
                market_regime: "市場トレンド",
                regime_auto: "AUTO (ランダム)",
                regime_bull: "BULL (上昇)",
                regime_range: "RANGE (レンジ)",
                regime_bear: "BEAR (下降)",
                control_range: "操作幅",
                volatility_label: "変動率 (Volatility)",
                vol_low: "低 (0.1)",
                vol_normal: "中 (0.2)",
                vol_high: "高 (0.8)",
                vol_extreme: "極大 (2.0)",
                btn_cancel: "キャンセル",
                btn_apply: "適用 & リセット",
                alert_margin: "証拠金不足です！",
                alert_liquidation: "ロスカット執行！口座残高がゼロになりました。",
                trend_range: "RANGE (レンジ)",
                trend_bull: "UP TREND (上昇)",
                trend_bear: "DOWN TREND (下降)",
                pos_none: "ポジションなし",
                alert_liq_msg: "ロスカット執行！(爆倉)\n口座残高がゼロになりました。\n左上の「RESET」ボタンで再開してください。",
                confirm_reset: "シミュレーションをリセットしますか？"
            },
            en: {
                reset: "RESET",
                leverage_label: "Leverage",
                equity_label: "Equity",
                next_label: "Next",
                hint_label: "Hint: Scroll to zoom • Slider to control price",
                ob_title: "ORDER BOOK",
                ob_vol: "Vol",
                control_label: "Control",
                reset_view: "Reset View",
                lot_label: "Lots",
                avg_price_label: "Avg Price",
                pl_label: "Profit/Loss",
                btn_sell: "SELL",
                btn_buy: "BUY",
                market_open: "MARKET OPEN",
                entry_short: "Entry",
                current_short: "Curr",
                settings_title: "Settings",
                language_label: "Language",
                initial_balance: "Initial Balance",
                market_regime: "Market Regime",
                regime_auto: "AUTO",
                regime_bull: "BULL (Up)",
                regime_range: "RANGE (Flat)",
                regime_bear: "BEAR (Down)",
                control_range: "Control Range",
                volatility_label: "Volatility",
                vol_low: "Low (0.1)",
                vol_normal: "Normal (0.2)",
                vol_high: "High (0.8)",
                vol_extreme: "Extreme (2.0)",
                btn_cancel: "Cancel",
                btn_apply: "Apply & Reset",
                alert_margin: "Insufficient Margin!",
                alert_liquidation: "Liquidation triggered! Balance is zero.",
                trend_range: "RANGE",
                trend_bull: "UP TREND",
                trend_bear: "DOWN TREND",
                pos_none: "NO POSITION",
                alert_liq_msg: "Liquidation Triggered!\nBalance is zero.\nPlease click 'RESET' to restart.",
                confirm_reset: "Are you sure you want to reset the simulation?"
            },
            zh: {
                reset: "重置",
                leverage_label: "杠杆",
                equity_label: "净值 (Equity)",
                next_label: "下根K线",
                hint_label: "提示: 滚轮缩放 • 拖动滑块控制价格",
                ob_title: "订单薄 (BOOK)",
                ob_vol: "量",
                control_label: "控制",
                reset_view: "回看最新",
                lot_label: "手数",
                avg_price_label: "持仓成本",
                pl_label: "浮动盈亏",
                btn_sell: "做空 (SELL)",
                btn_buy: "做多 (BUY)",
                market_open: "市场开启",
                entry_short: "成本",
                current_short: "现价",
                settings_title: "设置",
                language_label: "语言 (Language)",
                initial_balance: "初始资金",
                market_regime: "市场走势",
                regime_auto: "AUTO (随机)",
                regime_bull: "BULL (震荡上行)",
                regime_range: "RANGE (震荡)",
                regime_bear: "BEAR (震荡下行)",
                control_range: "控制幅度",
                volatility_label: "波动幅度",
                vol_low: "低 (0.1)",
                vol_normal: "标准 (0.2)",
                vol_high: "高 (0.8)",
                vol_extreme: "极高 (2.0)",
                btn_cancel: "取消",
                btn_apply: "应用并重置",
                alert_margin: "保证金不足！",
                alert_liquidation: "爆仓！余额归零。",
                trend_range: "震荡 (RANGE)",
                trend_bull: "多头趋势 (UP)",
                trend_bear: "空头趋势 (DOWN)",
                pos_none: "无持仓",
                alert_liq_msg: "爆仓警告！\n账户余额已归零。\n请点击左上角「重置」按钮重新开始。",
                confirm_reset: "确定要重置模拟器吗？"
            }
        };

        const LEVERAGE_STEPS = [1, 10, 20, 25, 50, 100, 200, 500, 1000];

        const CONFIG = {
            symbol: 'AUDJPY', 
            lotSize: 100000,
            spread: 0.015,
            marketTickRate: 100, 
            candleInterval: 3000,
            visibleCandles: 30,
            paddingTopBottom: 0.3,
            rightGutter: 50,
            sliderRange: 2.5, 
            volatilityMultiplier: 0.2, 
            maPeriod: 14,
            symbols: {
                'AUDJPY': { base: 97.450, vol: 0.015 },
                'USDJPY': { base: 150.000, vol: 0.025 }
            }
        };

        const defaultState = {
            price: 97.450,
            initialBalance: 10000, 
            balance: 10000,
            equity: 10000,
            leverage: 20, 
            position: null, 
            candles: [],
            lastCandleTime: 0,
            offsetX: 0,
            regime: 'auto',
            regimeTimer: 0,
            trendStrength: 0,
            momentum: 0,
            isUserInteracting: false,
            dragStartPrice: null, 
            language: 'zh' 
        };

        let state = JSON.parse(JSON.stringify(defaultState));
        let isDraggingChart = false;
        let lastMouseX = 0;

        const ui = {
            canvas: document.getElementById('klineChart'),
            container: document.getElementById('chart-container'),
            priceInput: document.getElementById('current-price-input'),
            slider: document.getElementById('price-slider'),
            resetBtn: document.getElementById('btn-reset'),
            settingsBtn: document.getElementById('btn-settings'),
            timerDisplay: document.getElementById('timer-display'),
            speedSelect: document.getElementById('speed-select'),
            
            leverageInput: document.getElementById('input-leverage-slider'), 
            topLeverage: document.getElementById('top-leverage-display'),
            bottomLeverage: document.getElementById('leverage-display-bottom'),

            symbolSelect: document.getElementById('symbol-select'),
            marketStatus: document.getElementById('market-status'),
            controlLabel: document.getElementById('control-label-text'),
            
            btnBuy: document.getElementById('btn-buy'),
            btnSell: document.getElementById('btn-sell'),
            btnPriceBuy: document.getElementById('btn-price-buy'),
            btnPriceSell: document.getElementById('btn-price-sell'),
            lotsInput: document.getElementById('input-lots'),
            costInput: document.getElementById('input-cost'),
            topEquity: document.getElementById('top-equity-display'),
            bottomPl: document.getElementById('bottom-pl-display'),
            posInfoBar: document.getElementById('pos-info-bar'),
            posTypeBadge: document.getElementById('pos-type-badge'),
            posSizeDisplay: document.getElementById('pos-size-display'),
            posEntryPrice: document.getElementById('pos-entry-price'),
            posCurrentPrice: document.getElementById('pos-current-price'),
            obAsks: document.getElementById('ob-asks'),
            obBids: document.getElementById('ob-bids'),
            obCurrent: document.getElementById('ob-current'),
            
            modal: document.getElementById('settings-modal'),
            settingBalance: document.getElementById('setting-balance'),
            settingRegime: document.getElementById('setting-regime'),
            settingLanguage: document.getElementById('setting-language'),
            settingRange: document.getElementById('setting-range'),
            settingVolatility: document.getElementById('setting-volatility'),
            btnApplySettings: document.getElementById('btn-apply-settings'),
            btnCloseSettings: document.getElementById('btn-close-settings'),
            lotPercentSlider: document.getElementById('lot-percent-slider'),
            lotPercentDisplay: document.getElementById('lot-percent-display')
        };

        const ctx = ui.canvas.getContext('2d');
        let width, height;

        function t(key) {
            const lang = state.language || 'zh';
            return TRANSLATIONS[lang][key] || key;
        }

        function updateLanguage() {
            const lang = state.language;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (TRANSLATIONS[lang][key]) el.innerText = TRANSLATIONS[lang][key];
            });
            updateSliderLabel();
            updateUI();
            updateMarketStatusText();
        }

        function updateSliderLabel() {
            ui.controlLabel.innerText = `${t('control_label')} (±${CONFIG.sliderRange}%)`;
            ui.slider.min = -CONFIG.sliderRange;
            ui.slider.max = CONFIG.sliderRange;
        }

        function init() {
            resetSystem(true);
            resize();
            loop();
        }

        function resetSystem(isFullReset = false) {
            const currentSymbol = CONFIG.symbol;
            const currentLev = state.leverage;
            const configBalance = state.initialBalance || 10000; 
            const configRegime = state.regime || 'auto';
            const currentLang = state.language || 'zh';

            state = JSON.parse(JSON.stringify(defaultState));
            state.language = currentLang;
            state.leverage = currentLev;
            state.initialBalance = configBalance;
            state.balance = configBalance;
            state.equity = configBalance;
            state.regime = configRegime;
            CONFIG.symbol = currentSymbol;

            const symConfig = CONFIG.symbols[currentSymbol];
            let p = symConfig.base + (Math.random() - 0.5) * 5.0; 
            
            let time = Date.now() - 50 * CONFIG.candleInterval;
            state.candles = [];
            for(let i=0; i<50; i++) {
                const change = (Math.random() - 0.5) * (symConfig.vol * 2);
                const o = p;
                const c = p + change;
                const h = Math.max(o, c) + Math.random() * (symConfig.vol);
                const l = Math.min(o, c) - Math.random() * (symConfig.vol);
                // 初始成交量随机
                const v = Math.random() * 100;
                state.candles.push({ time, open: o, high: h, low: l, close: c, volume: v });
                p = c;
                time += CONFIG.candleInterval;
            }
            state.price = p;
            state.lastCandleTime = Date.now();
            startNewCandle(p);
            
            ui.costInput.disabled = true;
            ui.costInput.value = "0.000";
            ui.costInput.className = "stealth-input mono font-bold text-slate-400";
            ui.lotPercentSlider.value = 0;
            ui.lotPercentDisplay.innerText = "0%";
            ui.settingLanguage.value = currentLang; 
            
            const levIndex = LEVERAGE_STEPS.indexOf(currentLev);
            if (levIndex !== -1) ui.leverageInput.value = levIndex;
            
            updateLanguage();
            updatePriceInputs(p);
            updateUI();
            updateOrderBook(p);
        }

        function startNewCandle(p) {
            const now = Date.now();
            state.lastCandleTime = now;
            state.candles.push({ time: now, open: p, high: p, low: p, close: p, volume: 0 });
            if(state.candles.length > 300) state.candles.shift();
        }

        function updateMarketLogic() {
            if (state.regime === 'auto') {
                state.regimeTimer--;
                if(state.regimeTimer <= 0) {
                    const rand = Math.random();
                    if(rand < 0.5) switchRegimeInternal('range');
                    else if (rand < 0.75) switchRegimeInternal('bull');
                    else switchRegimeInternal('bear');
                    state.regimeTimer = 50 + Math.floor(Math.random() * 100); 
                }
            } else {
                if (state.trendStrength === 0 && state.regime !== 'range' && state.regime !== 'auto') {
                    switchRegimeInternal(state.regime);
                }
            }

            let change = 0;
            const symConfig = CONFIG.symbols[CONFIG.symbol];
            const noise = (Math.random() - 0.5) * (symConfig.vol * CONFIG.volatilityMultiplier);

            if(state.trendStrength === 0) { 
                change = noise * 1.5;
            } else {
                state.momentum = state.momentum * 0.95 + state.trendStrength * 0.05;
                change = state.momentum + noise;
            }
            
            let baseP = state.isUserInteracting && state.userTargetPrice !== null ? state.userTargetPrice : state.price;
            
            // Volume Logic
            const volBase = Math.random() * 5;
            const volMultiplier = state.isUserInteracting ? 15 : 1; // Interacting boosts volume
            const tickVol = volBase * volMultiplier;
            
            // Add volume to current candle
            const currentCandle = state.candles[state.candles.length - 1];
            if (currentCandle) {
                currentCandle.volume = (currentCandle.volume || 0) + tickVol;
            }

            return baseP + change;
        }

        function switchRegimeInternal(type) {
            if (type === 'range') state.trendStrength = 0;
            else if (type === 'bull') state.trendStrength = 0.0002 + Math.random() * 0.0002;
            else if (type === 'bear') state.trendStrength = -0.0002 - Math.random() * 0.0002;
            updateMarketStatusText(type);
        }

        function updateMarketStatusText(type) {
            if (!type) {
                if (state.trendStrength > 0) type = 'bull';
                else if (state.trendStrength < 0) type = 'bear';
                else type = 'range';
            }
            let key = 'trend_range';
            let style = 'bg-slate-800 text-slate-500';
            if (type === 'bull') { key = 'trend_bull'; style = 'bg-green-900/30 text-green-400 border border-green-900/50'; }
            else if (type === 'bear') { key = 'trend_bear'; style = 'bg-red-900/30 text-red-400 border border-red-900/50'; }
            ui.marketStatus.innerText = t(key);
            ui.marketStatus.className = `hidden sm:flex text-[10px] px-2 py-1 rounded font-mono uppercase tracking-wide ${style}`;
        }

        function setPrice(p) {
            state.price = p;
            const c = state.candles[state.candles.length - 1];
            c.close = p;
            if(p > c.high) c.high = p;
            if(p < c.low) c.low = p;
            
            const now = Date.now();
            if(now - state.lastCandleTime >= CONFIG.candleInterval) {
                startNewCandle(p);
                if(!isDraggingChart && state.offsetX > 0) state.offsetX = 0;
            }
            
            const remaining = Math.max(0, CONFIG.candleInterval - (now - state.lastCandleTime));
            ui.timerDisplay.innerText = (remaining / 1000).toFixed(1);
            
            updateUI();
            if(Math.random() < 0.3) updateOrderBook(p);
        }

        ui.leverageInput.addEventListener('input', (e) => {
            const idx = parseInt(e.target.value);
            const lev = LEVERAGE_STEPS[idx];
            state.leverage = lev;
            const text = "1:" + lev;
            ui.topLeverage.innerText = text;
            ui.bottomLeverage.innerText = text;
        });

        ui.settingsBtn.addEventListener('click', () => {
            ui.modal.classList.remove('hidden');
            ui.settingBalance.value = state.initialBalance;
            ui.settingRegime.value = state.regime;
            ui.settingLanguage.value = state.language;
            ui.settingRange.value = CONFIG.sliderRange;
            ui.settingVolatility.value = CONFIG.volatilityMultiplier;
        });
        ui.btnCloseSettings.addEventListener('click', () => ui.modal.classList.add('hidden'));
        ui.btnApplySettings.addEventListener('click', () => {
            const newBal = parseFloat(ui.settingBalance.value);
            const newRegime = ui.settingRegime.value;
            const newLang = ui.settingLanguage.value;
            const newRange = parseFloat(ui.settingRange.value);
            const newVol = parseFloat(ui.settingVolatility.value);

            if (isNaN(newBal) || newBal <= 0) { alert("Invalid Balance"); return; }
            
            state.initialBalance = newBal; 
            state.regime = newRegime; 
            state.language = newLang;
            CONFIG.sliderRange = newRange;
            CONFIG.volatilityMultiplier = newVol;

            if(newRegime !== 'auto') switchRegimeInternal(newRegime);
            else { state.trendStrength = 0; updateMarketStatusText('range'); }
            
            updateLanguage(); 
            ui.modal.classList.add('hidden'); 
            resetSystem(); 
        });

        ui.slider.addEventListener('mousedown', startSlide);
        ui.slider.addEventListener('touchstart', (e) => startSlide(e), {passive: true});
        ui.slider.addEventListener('input', moveSlide);
        ui.slider.addEventListener('mouseup', endSlide);
        ui.slider.addEventListener('touchend', endSlide);

        function startSlide(e) {
            state.isUserInteracting = true;
            state.dragStartPrice = state.price; 
            state.offsetX = 0;
        }

        function moveSlide(e) {
            if (state.dragStartPrice === null) return;
            const percent = parseFloat(e.target.value); 
            const factor = 1 + (percent / 100);
            const targetPrice = state.dragStartPrice * factor;
            state.userTargetPrice = targetPrice;
        }

        function endSlide(e) {
            state.isUserInteracting = false;
            state.userTargetPrice = null;
            state.dragStartPrice = null;
            ui.slider.value = 0; 
        }

        ui.container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = Math.sign(e.deltaY);
            let newVisible = CONFIG.visibleCandles + delta * 2;
            if (newVisible < 10) newVisible = 10;
            if (newVisible > 200) newVisible = 200;
            CONFIG.visibleCandles = newVisible;
        }, { passive: false });

        ui.priceInput.addEventListener('focus', () => state.isUserInteracting = true);
        ui.priceInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(!isNaN(val)) { state.userTargetPrice = val; }
        });
        ui.priceInput.addEventListener('blur', () => { state.isUserInteracting = false; state.userTargetPrice = null; });

        ui.lotPercentSlider.addEventListener('input', (e) => {
            const pct = parseInt(e.target.value);
            ui.lotPercentDisplay.innerText = pct + "%";
            if (pct === 0) return;
            const maxBuyingPower = state.equity * state.leverage;
            const contractValue = state.price * CONFIG.lotSize; 
            const maxLots = maxBuyingPower / contractValue;
            const selectedLots = maxLots * (pct / 100);
            let finalLots = Math.floor(selectedLots * 10) / 10;
            if (finalLots < 0.1) finalLots = 0.1; 
            ui.lotsInput.value = finalLots.toFixed(1);
        });
        ui.lotsInput.addEventListener('input', () => ui.lotPercentDisplay.innerText = "Custom");

        ui.symbolSelect.addEventListener('change', (e) => { CONFIG.symbol = e.target.value; resetSystem(); ui.symbolSelect.blur(); });
        ui.resetBtn.addEventListener('click', () => { if(confirm(t('confirm_reset'))) resetSystem(); });
        document.getElementById('reset-view-btn').addEventListener('click', () => { state.offsetX = 0; });

        ui.btnBuy.addEventListener('click', () => trade('buy'));
        ui.btnSell.addEventListener('click', () => trade('sell'));
        ui.speedSelect.addEventListener('change', (e) => { CONFIG.candleInterval = parseInt(e.target.value); ui.speedSelect.blur(); });

        function trade(type) {
            const tradeLots = parseFloat(ui.lotsInput.value);
            const currentPrice = state.price;
            const tradePrice = type === 'buy' ? currentPrice + CONFIG.spread : currentPrice;
            const requiredMargin = (tradePrice * tradeLots * CONFIG.lotSize) / state.leverage;

            let isOpeningOrAdding = true;
            if (state.position && state.position.type !== type && tradeLots <= state.position.lots) isOpeningOrAdding = false; 

            if (isOpeningOrAdding && state.equity < requiredMargin) {
                alert(`${t('alert_margin')}\nReq: ¥${Math.floor(requiredMargin).toLocaleString()}\nAvail: ¥${Math.floor(state.equity).toLocaleString()}`);
                return;
            }

            if (!state.position) {
                const liq = calculateLiquidationPrice(tradePrice, tradeLots, type, state.balance);
                state.position = { type, lots: tradeLots, price: tradePrice, liquidationPrice: liq, leverage: state.leverage };
            } else {
                if (state.position.type === type) {
                    const totalLots = state.position.lots + tradeLots;
                    const avgPrice = ((state.position.price * state.position.lots) + (tradePrice * tradeLots)) / totalLots;
                    state.position.lots = totalLots;
                    state.position.price = avgPrice;
                    state.position.liquidationPrice = calculateLiquidationPrice(avgPrice, totalLots, type, state.balance);
                } else {
                    const closeLots = Math.min(state.position.lots, tradeLots);
                    const diff = state.position.type === 'buy' ? tradePrice - state.position.price : state.position.price - tradePrice;
                    state.balance += diff * closeLots * CONFIG.lotSize;
                    if (tradeLots < state.position.lots) {
                        state.position.lots -= tradeLots;
                        state.position.liquidationPrice = calculateLiquidationPrice(state.position.price, state.position.lots, state.position.type, state.balance);
                    } else if (tradeLots === state.position.lots) {
                        state.position = null;
                    } else {
                        const remainingLots = tradeLots - state.position.lots;
                        const liq = calculateLiquidationPrice(tradePrice, remainingLots, type, state.balance);
                        state.position = { type, lots: remainingLots, price: tradePrice, liquidationPrice: liq, leverage: state.leverage };
                    }
                }
            }
            if (state.position) { ui.costInput.disabled = false; ui.costInput.value = state.position.price.toFixed(3); ui.costInput.className = "stealth-input mono font-bold text-white"; }
            else { ui.costInput.disabled = true; ui.costInput.value = "0.000"; ui.costInput.className = "stealth-input mono font-bold text-slate-400"; }
            updateUI();
        }

        function calculateLiquidationPrice(entry, lots, type, bal) {
            const move = bal / (lots * CONFIG.lotSize);
            return type === 'buy' ? entry - move : entry + move;
        }

        let lastTickTime = 0;
        function loop() {
            const now = Date.now();
            const tickInterval = CONFIG.marketTickRate;

            if (now - lastTickTime > tickInterval) {
                const newPrice = updateMarketLogic();
                setPrice(newPrice);
                updatePriceInputs(newPrice);
                lastTickTime = now;
            }

            draw();
            requestAnimationFrame(loop);
        }

        function updatePriceInputs(p) {
            if(document.activeElement !== ui.priceInput) {
                ui.priceInput.value = p.toFixed(3);
                const prev = state.candles.length > 1 ? state.candles[state.candles.length-2].close : p;
                ui.priceInput.className = `price-input text-2xl text-right ${p >= prev ? 'text-green-400' : 'text-red-400'}`;
            }
        }

        function updateUI() {
            ui.btnPriceSell.innerText = t('btn_sell') + " " + state.price.toFixed(3);
            ui.btnPriceBuy.innerText = t('btn_buy') + " " + (state.price + CONFIG.spread).toFixed(3);

            let pl = 0;
            if(state.position) {
                const diff = state.position.type === 'buy' ? state.price - state.position.price : state.position.price - state.price;
                pl = diff * state.position.lots * CONFIG.lotSize;
                ui.posInfoBar.classList.remove('hidden');
                const typeText = state.position.type === 'buy' ? t('btn_buy') : t('btn_sell');
                const typeClass = state.position.type === 'buy' ? 'bg-green-600 text-white' : 'bg-red-600 text-white';
                ui.posTypeBadge.textContent = typeText;
                ui.posTypeBadge.className = `px-2 py-0.5 rounded text-xs font-bold uppercase ${typeClass}`;
                ui.posSizeDisplay.textContent = state.position.lots.toFixed(1) + " Lot";
                ui.posEntryPrice.textContent = state.position.price.toFixed(3);
                ui.posCurrentPrice.textContent = state.price.toFixed(3);
            } else {
                ui.posInfoBar.classList.add('hidden');
            }

            const equity = state.balance + pl;
            state.equity = equity; 
            const pct = state.balance > 0 ? (pl / state.balance) * 100 : 0.00;
            const sign = pl >= 0 ? '+' : '';
            const plText = `${sign}¥${Math.floor(pl).toLocaleString()} (${sign}${pct.toFixed(2)}%)`;
            ui.topEquity.innerText = "¥" + Math.floor(equity).toLocaleString();
            ui.bottomPl.innerText = plText;
            ui.bottomPl.className = `mono text-lg font-bold ${pl >= 0 ? 'text-green-500' : 'text-red-500'}`;

            if(equity <= 0 && state.position) {
                alert(t('alert_liq_msg'));
                resetSystem();
            }
        }

        function updateOrderBook(price) {
            ui.obCurrent.innerText = price.toFixed(3);
            ui.obCurrent.className = `py-1 bg-slate-800 text-center mono text-sm font-bold border-y border-slate-700 ${state.candles.length > 1 && price >= state.candles[state.candles.length-2].close ? 'text-green-400' : 'text-red-400'}`;
            const generateRows = (basePrice, type, count) => {
                let html = '';
                for(let i=1; i<=count; i++) {
                    const spread = i * 0.005 + (Math.random() * 0.005);
                    const p = type === 'ask' ? basePrice + spread : basePrice - spread;
                    const vol = (Math.random() * 5 + 0.5).toFixed(2);
                    const widthPct = Math.min(100, (vol / 5) * 100);
                    const bgClass = type === 'ask' ? 'bg-red-500' : 'bg-green-500';
                    const textClass = type === 'ask' ? 'text-red-400' : 'text-green-400';
                    const rowHtml = `<div class="relative order-book-row cursor-pointer hover:bg-slate-800"><div class="order-book-bar ${bgClass}" style="width: ${widthPct}%"></div><span class="${textClass} z-10">${p.toFixed(3)}</span><span class="text-slate-400 z-10">${vol}M</span></div>`;
                    if(type === 'ask') html = rowHtml + html; else html += rowHtml;
                }
                return html;
            };
            ui.obAsks.innerHTML = generateRows(price, 'ask', 8);
            ui.obBids.innerHTML = generateRows(price, 'bid', 8);
        }

        // Helper: Calculate Simple Moving Average
        function calculateSMA(candles, period) {
            if (candles.length < period) return null;
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += candles[candles.length - 1 - i].close;
            }
            return sum / period;
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            
            // Split View: Top 80% Price, Bottom 20% Volume
            const priceHeight = height * 0.8;
            const volHeight = height * 0.2;
            const volTopY = priceHeight; // Y position where volume starts

            const chartW = width - CONFIG.rightGutter;
            const candleW = chartW / CONFIG.visibleCandles;
            const offsetCount = Math.floor(state.offsetX / candleW);
            const endIndex = state.candles.length - 1 - offsetCount;
            const startIndex = endIndex - CONFIG.visibleCandles - 2;

            // Calculate Price Min/Max for Price Chart
            let maxP = -Infinity, minP = Infinity;
            let maxVol = 0; // Track max volume for scaling

            for(let i=Math.max(0, startIndex); i<=Math.min(state.candles.length-1, endIndex); i++) {
                const c = state.candles[i];
                if(c.high > maxP) maxP = c.high;
                if(c.low < minP) minP = c.low;
                if(c.volume > maxVol) maxVol = c.volume;
            }
            
            if(state.position) {
                if(state.position.price > maxP) maxP = state.position.price;
                if(state.position.price < minP) minP = state.position.price;
            }
            
            if(maxP === -Infinity) { maxP = state.price + 0.1; minP = state.price - 0.1; }
            if(maxVol === 0) maxVol = 100; // Default fallback

            // Price Scale Logic
            const range = Math.max(maxP - minP, 0.05);
            const padding = range * CONFIG.paddingTopBottom;
            const drawMax = maxP + padding;
            const drawMin = minP - padding;
            
            // Helper: Price to Y
            const getPriceY = p => priceHeight - ((p - drawMin) / (drawMax - drawMin)) * priceHeight;
            // Helper: Vol to Y (relative to volume area)
            const getVolHeight = v => (v / maxVol) * (volHeight * 0.9); // Max height 90% of area

            // 1. Draw Grid & Axis (Price Area)
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=1; i<5; i++) {
                const p = drawMin + (drawMax - drawMin)/5 * i;
                const y = getPriceY(p);
                ctx.moveTo(0, y); ctx.lineTo(width, y);
                ctx.fillStyle = '#64748b'; ctx.font = '11px JetBrains Mono';
                ctx.fillText(p.toFixed(3), chartW + 5, y + 4);
            }
            ctx.stroke();

            // 2. Separator Line
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; ctx.beginPath();
            ctx.moveTo(0, priceHeight); ctx.lineTo(width, priceHeight);
            ctx.stroke();

            // 3. Helper Lines (Cost/Liq)
            ctx.save(); ctx.beginPath(); ctx.rect(0, 0, chartW, priceHeight); ctx.clip();
            if(state.position) {
                const yc = getPriceY(state.position.price);
                if(yc > -20 && yc < priceHeight+20) {
                    ctx.beginPath(); ctx.strokeStyle='#3b82f6'; ctx.setLineDash([5,3]); ctx.lineWidth=1;
                    ctx.moveTo(0, yc); ctx.lineTo(chartW, yc); ctx.stroke();
                    ctx.fillStyle='#3b82f6'; ctx.font='bold 10px JetBrains Mono';
                    ctx.fillText('AVG', 5, yc - 4);
                }
                const yl = getPriceY(state.position.liquidationPrice);
                if(yl > -20 && yl < priceHeight+20) {
                    ctx.beginPath(); ctx.strokeStyle='#f97316'; ctx.setLineDash([2,2]); ctx.lineWidth=1;
                    ctx.moveTo(0, yl); ctx.lineTo(chartW, yl); ctx.stroke();
                    ctx.fillStyle='#f97316'; ctx.font='bold 10px JetBrains Mono';
                    ctx.fillText('LIQ', 5, yl - 4);
                }
            }
            ctx.setLineDash([]);

            // 4. Candles & Volume & MA Loop
            // First pass: Candles and Volume
            for(let i=0; i<state.candles.length; i++) {
                const idxFromEnd = state.candles.length - 1 - i;
                const x = chartW + state.offsetX - (idxFromEnd * candleW) - candleW;
                
                if(x > chartW + 50 || x < -50) continue;

                const c = state.candles[i];
                const isBull = c.close >= c.open;
                const color = isBull ? '#22c55e' : '#ef4444';
                
                // --- Price Candle ---
                const yO = getPriceY(c.open);
                const yC = getPriceY(c.close);
                const yH = getPriceY(c.high);
                const yL = getPriceY(c.low);

                ctx.fillStyle = color; ctx.strokeStyle = color; ctx.lineWidth = 1;
                // Wick
                ctx.beginPath(); ctx.moveTo(x + candleW/2, yH); ctx.lineTo(x + candleW/2, yL); ctx.stroke();
                // Body
                const hBody = Math.max(1, Math.abs(yC - yO));
                ctx.fillRect(x+1, Math.min(yO, yC), candleW-2, hBody);

                // --- Volume Bar ---
                const vH = getVolHeight(c.volume);
                const vY = height - vH; // Bottom anchored
                // Set opacity slightly lower for volume
                ctx.globalAlpha = 0.5;
                ctx.fillRect(x+1, vY, candleW-2, vH);
                ctx.globalAlpha = 1.0;
            }

            // 5. Moving Average (Yellow Line)
            ctx.beginPath();
            ctx.strokeStyle = '#fbbf24'; // Yellow-400
            ctx.lineWidth = 2;
            let firstPoint = true;

            // We iterate visible range again for MA path
            for(let i=0; i<state.candles.length; i++) {
                const idxFromEnd = state.candles.length - 1 - i;
                const x = chartW + state.offsetX - (idxFromEnd * candleW) - candleW/2; // center of candle
                
                // Optimization: Draw a bit outside screen for continuity
                if(x > chartW + 100 || x < -100) continue;

                // Calc MA manually for this index
                // Note: This is O(N*M) where M is visible, N is MA Period. Fine for 30-100 candles.
                if (i < CONFIG.maPeriod - 1) continue; // Not enough data
                
                let sum = 0;
                for (let k = 0; k < CONFIG.maPeriod; k++) {
                    sum += state.candles[i - k].close;
                }
                const maVal = sum / CONFIG.maPeriod;
                const maY = getPriceY(maVal);

                if (firstPoint) {
                    ctx.moveTo(x, maY);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, maY);
                }
            }
            ctx.stroke();

            ctx.restore(); // End clip

            // 6. Current Price Line (Crosses everything in Price Area)
            const yCur = getPriceY(state.price);
            if(yCur > -20 && yCur < priceHeight + 20) {
                ctx.beginPath(); ctx.strokeStyle='#94a3b8'; ctx.setLineDash([2,2]); ctx.lineWidth=1;
                ctx.moveTo(0, yCur); ctx.lineTo(chartW, yCur); ctx.stroke(); ctx.setLineDash([]);
                
                ctx.fillStyle = state.price >= (state.candles[state.candles.length-2]?.close||0) ? '#22c55e' : '#ef4444';
                ctx.fillRect(chartW, yCur-10, CONFIG.rightGutter, 20);
                ctx.fillStyle = '#fff'; ctx.font='bold 11px JetBrains Mono';
                ctx.fillText(state.price.toFixed(3), chartW+5, yCur+4);
            }
        }

        function resize() {
            width = ui.container.offsetWidth;
            height = ui.container.offsetHeight;
            ui.canvas.width = width;
            ui.canvas.height = height;
        }
        window.addEventListener('resize', resize);
        
        init();

    </script>
</body>
</html>
